name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  frontend-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-service/package-lock.json

      - name: Install Dependencies
        working-directory: ./frontend-service
        run: npm ci

      - name: Lint (Static Analysis)
        working-directory: ./frontend-service
        run: npm run lint

      - name: Unit Tests & Coverage
        working-directory: ./frontend-service
        run: npm run test:coverage

      - name: Upload Frontend Coverage Report
        if: always() # Run even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-report
          path: frontend-service/coverage/
          retention-days: 30

  backend-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Test Auth Service
        working-directory: ./auth-service
        run: mvn test jacoco:report checkstyle:check

      - name: Upload Auth Service Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auth-service-coverage
          path: auth-service/target/site/jacoco/
          retention-days: 30

      - name: Test Recruitment Service
        working-directory: ./recruitment-service
        run: mvn test jacoco:report checkstyle:check

      - name: Upload Recruitment Service Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: recruitment-service-coverage
          path: recruitment-service/target/site/jacoco/
          retention-days: 30

      - name: Test API Gateway
        working-directory: ./api-gateway-service
        run: mvn test jacoco:report checkstyle:check

  publish-reports:
    needs: [frontend-ci, backend-ci]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage-report
          path: _site/frontend

      - name: Download Auth Artifact
        uses: actions/download-artifact@v4
        with:
          name: auth-service-coverage
          path: _site/auth

      - name: Download Recruitment Artifact
        uses: actions/download-artifact@v4
        with:
          name: recruitment-service-coverage
          path: _site/recruitment

      - name: Create Index Page
        run: |
          echo "<html><body>" > _site/index.html
          echo "<h1>Test Coverage Reports</h1>" >> _site/index.html
          echo "<ul>" >> _site/index.html
          echo "<li><a href='frontend/index.html'>Frontend (React/Vitest)</a></li>" >> _site/index.html
          echo "<li><a href='auth/index.html'>Auth Service (Java/JaCoCo)</a></li>" >> _site/index.html
          echo "<li><a href='recruitment/index.html'>Recruitment Service (Java/JaCoCo)</a></li>" >> _site/index.html
          echo "</ul>" >> _site/index.html
          echo "</body></html>" >> _site/index.html

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  deploy:
    # DO NOT REMOVE!!!!!!! 
    # This line makes Deployment wait for Tests to pass! 
    needs: [frontend-ci, backend-ci]
    
    runs-on: ubuntu-latest
    # Only deploy if we are pushing to main
    if: github.ref == 'refs/heads/main' 
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: SSH and Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd iv1201-recruitment-app
            git pull origin main
            # Rebuild ensures new code is actually running
            sudo docker compose down
            sudo docker compose up -d --build
            sudo docker image prune -f

      - name: Health Check (Verify Deployment)
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "Waiting for service to be ready at http://$EC2_HOST:3000..."
          for i in {1..12}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$EC2_HOST:3000 || echo "000")
            if [ "$STATUS" == "200" ]; then
              echo "✅ Service is UP!"
              exit 0
            fi
            echo "Attempt $i: Status $STATUS. Waiting 5s..."
            sleep 5
          done
          echo "❌ Deployment failed."
          exit 1