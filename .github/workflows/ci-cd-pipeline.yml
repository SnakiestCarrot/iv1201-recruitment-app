name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  frontend-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-service/package-lock.json

      - name: Install Dependencies
        working-directory: ./frontend-service
        run: npm ci

      - name: Lint (Static Analysis)
        working-directory: ./frontend-service
        run: npm run lint

      - name: Unit Tests
        working-directory: ./frontend-service
        run: npm test -- --run

  backend-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # auth service
      - name: Test Auth Service
        working-directory: ./auth-service
        run: mvn test checkstyle:check

      # recruitment service
      - name: Test Recruitment Service
        working-directory: ./recruitment-service
        run: mvn test checkstyle:check

      # API gateway
      - name: Test API Gateway
        working-directory: ./api-gateway-service
        run: mvn test checkstyle:check

  # Deployment Job
  deploy:
    # DO NOT REMOVE!!!!!!! 
    # This line makes Deployment wait for Tests to pass! 
    # Lets not deploy code that doesnt pass tests :)
    needs: [frontend-ci, backend-ci]
    
    runs-on: ubuntu-latest
    # Only deploy if we are pushing to main
    if: github.ref == 'refs/heads/main' 
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: SSH and Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd iv1201-recruitment-app
            git pull origin main
            # Rebuild ensures new code is actually running
            sudo docker compose down
            sudo docker compose up -d --build
            sudo docker image prune -f

      - name: Health Check (Verify Deployment)
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "Waiting for service to be ready at http://$EC2_HOST:3000..."
          for i in {1..12}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$EC2_HOST:3000 || echo "000")
            if [ "$STATUS" == "200" ]; then
              echo "✅ Service is UP!"
              exit 0
            fi
            echo "Attempt $i: Status $STATUS. Waiting 5s..."
            sleep 5
          done
          echo "❌ Deployment failed."
          exit 1
